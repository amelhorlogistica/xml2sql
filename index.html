<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML para SQL - NF-e Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #121212;
            color: #e0e0e0;
        }
        .bg-custom-dark { background-color: #212121; }
        .border-custom-accent { border-color: #3d3d3d; }
        .drop-zone--over { border-color: #60a5fa; background-color: #2a2a2a; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a1a1a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="w-full max-w-5xl">
        <!-- Header -->
        <header class="mb-8 text-center md:text-left flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">NF-e <span class="text-blue-400">XML ➜ SQL</span></h1>
                <p class="text-gray-400 text-sm">Converta múltiplas Notas Fiscais para SQLite instantaneamente.</p>
            </div>
            <div id="statusBadge" class="hidden px-3 py-1 bg-blue-500/10 border border-blue-500/50 text-blue-400 rounded-full text-xs animate-pulse">
                Processando arquivos...
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Upload Section -->
            <div class="lg:col-span-5 space-y-6">
                <div id="dropZone" class="bg-custom-dark border-2 border-dashed border-custom-accent rounded-2xl p-8 flex flex-col items-center justify-center cursor-pointer transition-all hover:border-blue-500 group">
                    <input type="file" id="fileInput" multiple accept=".xml" class="hidden">
                    <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                    </div>
                    <p class="text-white font-medium mb-1">Arraste seus XMLs aqui</p>
                    <p class="text-gray-500 text-xs text-center">ou clique para selecionar arquivos do computador</p>
                </div>

                <!-- File List Container -->
                <div class="bg-custom-dark rounded-2xl p-5 border border-custom-accent">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400">Fila de Processamento</h3>
                        <span id="fileCount" class="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-300">0 arquivos</span>
                    </div>
                    <div id="fileList" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 text-xs">
                        <p class="text-gray-600 italic">Nenhum arquivo selecionado.</p>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="lg:col-span-7 space-y-6">
                <div class="bg-custom-dark rounded-2xl border border-custom-accent overflow-hidden flex flex-col h-full min-h-[400px]">
                    <div class="bg-[#1a1a1a] px-4 py-3 border-b border-custom-accent flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
                            <span class="ml-2 text-xs text-gray-500 font-mono">resultado_nfe.sql</span>
                        </div>
                        <button id="btnDownload" disabled class="opacity-50 cursor-not-allowed bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-1.5 rounded-lg font-bold transition-all flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            DOWNLOAD .SQL
                        </button>
                    </div>
                    <div class="relative flex-grow">
                        <pre id="sqlOutput" class="absolute inset-0 p-4 text-xs text-blue-300 overflow-auto custom-scrollbar whitespace-pre-wrap">-- O código SQL gerado aparecerá aqui...</pre>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Info -->
        <footer class="mt-8 pt-6 border-t border-custom-accent text-center text-gray-600 text-[10px] uppercase tracking-[0.2em]">
            Processamento 100% Client-Side • Privacidade Garantida • Engine de Conversão v1.0
        </footer>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileCountDisplay = document.getElementById('fileCount');
        const sqlOutput = document.getElementById('sqlOutput');
        const btnDownload = document.getElementById('btnDownload');
        const statusBadge = document.getElementById('statusBadge');

        let generatedSQL = "";

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone--over');
        });

        ['dragleave', 'dragend'].forEach(type => {
            dropZone.addEventListener(type, () => {
                dropZone.classList.remove('drop-zone--over');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone--over');
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });

        btnDownload.addEventListener('click', downloadSQL);

        async function handleFiles(files) {
            const xmlFiles = Array.from(files).filter(file => file.name.endsWith('.xml'));
            
            if (xmlFiles.length === 0) {
                showToast("Por favor, selecione apenas arquivos XML.");
                return;
            }

            statusBadge.classList.remove('hidden');
            fileList.innerHTML = '';
            fileCountDisplay.innerText = `${xmlFiles.length} arquivos`;

            let sqlCommands = [];
            
            // Create Table Statement
            const createTable = `CREATE TABLE IF NOT EXISTS tb_notas_fiscais (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nfe_chave TEXT,
    nfe_numero TEXT,
    nfe_serie TEXT,
    nfe_data_emissao TEXT,
    emitente_cnpj TEXT,
    emitente_nome TEXT,
    destinatario_cnpj_cpf TEXT,
    destinatario_nome TEXT,
    valor_total_nota REAL,
    valor_icms REAL,
    data_importacao DATETIME DEFAULT CURRENT_TIMESTAMP
);\n\n`;
            
            sqlCommands.push(createTable);

            for (const file of xmlFiles) {
                // Add to list UI
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-2 bg-[#2a2a2a] rounded border border-white/5";
                item.innerHTML = `
                    <span class="truncate pr-4">${file.name}</span>
                    <span class="text-[10px] text-green-500 font-bold uppercase">OK</span>
                `;
                fileList.appendChild(item);

                try {
                    const text = await file.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, "text/xml");

                    // Helper para pegar valores do XML com segurança
                    const getVal = (path) => {
                        const node = xmlDoc.querySelector(path);
                        return node ? node.textContent.replace(/'/g, "''") : "NULL";
                    };

                    // Extração de dados básica (Layout padrão NF-e)
                    const chave = xmlDoc.querySelector('infNFe')?.getAttribute('Id')?.replace('NFe', '') || "NULL";
                    const numero = getVal('ide > nNF');
                    const serie = getVal('ide > serie');
                    const dhEmi = getVal('ide > dhEmi');
                    
                    const emitCNPJ = getVal('emit > CNPJ');
                    const emitNome = getVal('emit > xNome');
                    
                    const destCNPJ = getVal('dest > CNPJ') !== "NULL" ? getVal('dest > CNPJ') : getVal('dest > CPF');
                    const destNome = getVal('dest > xNome');
                    
                    const vNF = getVal('total > ICMSTot > vNF');
                    const vICMS = getVal('total > ICMSTot > vICMS');

                    const insert = `INSERT INTO tb_notas_fiscais (nfe_chave, nfe_numero, nfe_serie, nfe_data_emissao, emitente_cnpj, emitente_nome, destinatario_cnpj_cpf, destinatario_nome, valor_total_nota, valor_icms) 
VALUES ('${chave}', '${numero}', '${serie}', '${dhEmi}', '${emitCNPJ}', '${emitNome}', '${destCNPJ}', '${destNome}', ${vNF}, ${vICMS});`;
                    
                    sqlCommands.push(insert);
                } catch (err) {
                    console.error("Erro ao processar arquivo:", file.name, err);
                }
            }

            generatedSQL = sqlCommands.join('\n');
            sqlOutput.textContent = generatedSQL;
            
            // Enable download
            btnDownload.disabled = false;
            btnDownload.classList.remove('opacity-50', 'cursor-not-allowed');
            statusBadge.classList.add('hidden');
        }

        function downloadSQL() {
            if (!generatedSQL) return;
            const blob = new Blob([generatedSQL], { type: 'text/sql' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            a.href = url;
            a.download = `importacao_nfe_${timestamp}.sql`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function showToast(msg) {
            // Simples aviso caso não seja XML
            const alertBox = document.createElement('div');
            alertBox.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold z-50 animate-bounce";
            alertBox.innerText = msg;
            document.body.appendChild(alertBox);
            setTimeout(() => alertBox.remove(), 3000);
        }
    </script>
</body>
</html>
